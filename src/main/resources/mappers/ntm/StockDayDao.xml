<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lemonico.ntm.dao.StockDayDao">

    <!-- 将数据每天存到Tw304表里面-->
    <insert id="insertAllData">
        insert into tw304_stock_day(stock_date, stock_id, warehouse_cd, client_id, product_id, available_cnt,
        requesting_cnt, inventory_cnt, replenish_cnt, product_size_cd, product_weight, weigth_unit, ins_usr,
        ins_date, upd_usr, upd_date, del_flg)
        values
        <foreach collection="stockDays" item="stock" separator="," >
            (#{stock.stock_date}, #{stock.stock_id}, #{stock.warehouse_cd}, #{stock.client_id}, #{stock.product_id}
            , #{stock.available_cnt}, #{stock.requesting_cnt}, #{stock.inventory_cnt}, #{stock.replenish_cnt}, #{stock.product_size_cd}
            , #{stock.product_weight}, #{stock.weigth_unit}, #{stock.ins_usr}, #{stock.ins_date}, #{stock.upd_usr}
            , #{stock.upd_date}, #{stock.del_flg})
        </foreach>
    </insert>

    <select id="getAllData" resultType="com.lemonico.common.bean.Tw304_stock_day">
        select stock_date, product_id, inventory_cnt, product_id
        from tw304_stock_day
        where del_flg = 0 and stock_date between #{minDate} and #{maxDate}
        <if test="warehouse_cd != null and warehouse_cd != '' ">
            and warehouse_cd = #{warehouse_cd}
        </if>
        <if test="client_id != null and client_id != '' ">
            and client_id = #{client_id}
        </if>
    </select>

    <!-- 获取某些日期的所有数据-->
    <select id="getDataByStockDate" resultType="com.lemonico.common.bean.Tw304_stock_day">
        select tw304.stock_date as stock_date, tw304.product_id as product_id, tw304.inventory_cnt as inventory_cnt, tw304.ins_date as ins_date, tw304.product_id as product_id
        from tw304_stock_day tw304
        left join mc100_product mc100 on tw304.product_id = mc100.product_id
        where tw304.del_flg = 0 and tw304.stock_date in
        <foreach collection="stock_date" item="stock_date" open="(" separator="," close=")">
            #{stock_date}
        </foreach>
        <if test="warehouse_cd != null and warehouse_cd != '' ">
            and tw304.warehouse_cd = #{warehouse_cd}
        </if>
        <if test="client_id != null and client_id != '' ">
            and tw304.client_id = #{client_id}
            and mc100.client_id = #{client_id}
        </if>
        order by mc100.sort_no asc;
    </select>

    <!-- 获取指定日期范围内的商品出库数-->
    <select id="getTotalOfShipmentsNumWithTime" resultType="hashmap">
        select tw201.product_id as product_id, count(tw201.product_id) as cnt
        from tw200_shipment tw200
        left join tw201_shipment_detail tw201 on tw201.shipment_plan_id = tw200.shipment_plan_id
        where tw200.shipment_status != 888
        <if test="clientId != null and clientId!= '' ">
            and tw200.client_id = #{clientId}
        </if>
        <if test="warehouseCd != null and warehouseCd != '' ">
            and tw200.warehouse_cd = #{warehouseCd}
        </if>
        <if test="startDate != null and startDate!= '' and endDate != null and endDate != ''">
            and tw200.shipment_plan_date between #{startDate} and #{endDate}
        </if>
        group by tw201.product_id;
    </select>

    <!-- 获取指定日期范围内的商品出库数-->
    <select id="getTotalOfShipmentsNumWithTime2" resultType="hashmap">
        select product_id, sum(quantity) as cnt
        from tw301_stock_history
        where type = 2
        <if test="clientId != null and clientId!= '' ">
            and client_id = #{clientId}
        </if>
        <if test="startDate != null and startDate!= '' and endDate != null and endDate != ''">
            and ins_date between #{startDate} and #{endDate}
        </if>
        group by product_id;
    </select>
</mapper>